

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local LP = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local FLY_SPEED = 60
local TOGGLE_KEY = Enum.KeyCode.F

local flying = false
local keys = {W=false, A=false, S=false, D=false, Space=false, Ctrl=false}

local bv, bg

local function startFly(char)
	local hrp = char:WaitForChild("HumanoidRootPart")
	local hum = char:WaitForChild("Humanoid")

	hum.PlatformStand = true

	-- BodyVelocity
	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp


	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
	bg.P = 9000
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	RunService.RenderStepped:Connect(function()
		if not flying then return end

		local moveDir = Vector3.zero

		if keys.W then moveDir += Camera.CFrame.LookVector end
		if keys.S then moveDir -= Camera.CFrame.LookVector end
		if keys.A then moveDir -= Camera.CFrame.RightVector end
		if keys.D then moveDir += Camera.CFrame.RightVector end
		if keys.Space then moveDir += Vector3.new(0,1,0) end
		if keys.Ctrl then moveDir -= Vector3.new(0,1,0) end

		if moveDir.Magnitude > 0 then
			moveDir = moveDir.Unit
		end

		bv.Velocity = moveDir * FLY_SPEED
		bg.CFrame = Camera.CFrame
	end)
end

local function stopFly(char)
	local hum = char:FindFirstChild("Humanoid")
	if hum then
		hum.PlatformStand = false
	end

	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
end


UIS.InputBegan:Connect(function(input, gp)
	if gp then return end

	if input.KeyCode == TOGGLE_KEY then
		flying = not flying
		if flying and LP.Character then
			startFly(LP.Character)
		elseif LP.Character then
			stopFly(LP.Character)
		end
	end

	if keys[input.KeyCode.Name] ~= nil then
		keys[input.KeyCode.Name] = true
	end
end)

UIS.InputEnded:Connect(function(input)
	if keys[input.KeyCode.Name] ~= nil then
		keys[input.KeyCode.Name] = false
	end
end)

LP.CharacterAdded:Connect(function(char)
	flying = false
	task.wait(0.3)
	stopFly(char)
end)
